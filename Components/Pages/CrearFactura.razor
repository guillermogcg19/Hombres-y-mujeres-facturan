@page "/Facturas"
@rendermode InteractiveServer

@using FACTURA.Components.Data
@inject ServicioFacturas ServicioFacturas
@inject NavigationManager Nav

<h2>📄 Nueva Factura</h2>

<div>
    <label>Fecha:</label>
    <input type="date" @bind="factura.Fecha" />

    <label>Cliente:</label>
    <input @bind="factura.Cliente" placeholder="Nombre del cliente" />

    <h4>Artículos</h4>

    <table border="1" cellpadding="4">
        <thead>
            <tr>
                <th>Articulo</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var a in articulosTemp)
            {
                <tr>
                    <td>@a.Nombre</td>
                    <td>@a.Cantidad</td>
                    <td>@a.Precio</td>
                    <td>@a.Subtotal</td>
                    <td>
                        <button @onclick="() => Quitar(a)">Quitar</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div style="margin-top:10px">
        <input placeholder="Artículo" @bind="nuevo.Nombre" />
        <input type="number" min="1" placeholder="Cantidad" @bind="nuevo.Cantidad" />
        <input type="number" step="0.01" placeholder="Precio" @bind="nuevo.Precio" />
        <button @onclick="Agregar">Agregar artículo</button>
    </div>

    <div style="margin-top:10px">
        <button @onclick="GuardarFactura">Guardar Factura</button>
        <button @onclick="@(() => Nav.NavigateTo("/ListaFacturas"))">Ver Lista</button>
    </div>
</div>

@code {
    private Factura factura = new();
    private Articulo nuevo = new();
    private List<Articulo> articulosTemp = new();

    private void Agregar()
    {
        if (!string.IsNullOrWhiteSpace(nuevo.Nombre) &&
            nuevo.Cantidad > 0 &&
            nuevo.Precio > 0)
        {
            articulosTemp.Add(new Articulo
            {
                Nombre = nuevo.Nombre,
                Cantidad = nuevo.Cantidad,
                Precio = nuevo.Precio
            });

            nuevo = new Articulo();
        }
    }

    private void Quitar(Articulo a) => articulosTemp.Remove(a);

    private async Task GuardarFactura()
    {
        if (string.IsNullOrWhiteSpace(factura.Cliente) || articulosTemp.Count == 0)
            return;

        factura.Articulos = new List<Articulo>(articulosTemp);

        await ServicioFacturas.CrearFactura(factura);

        factura = new Factura();
        nuevo = new Articulo();
        articulosTemp.Clear();

        Nav.NavigateTo("/ListaFacturas");
    }
}
