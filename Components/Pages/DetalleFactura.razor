@page "/DetalleFactura/{id:int}"
@rendermode InteractiveServer
@inject ServicioFacturas ServicioFacturas
@inject NavigationManager Nav
@using FACTURA.Components.Data

<h2>🧾 Detalle de Factura</h2>

@if (factura is null)
{
    <p>Cargando...</p>
}
else
{
    <div>
        <label><strong>Cliente:</strong></label>
        <input @bind="factura.Cliente" />

        <label><strong>Fecha:</strong></label>
        <input type="date" @bind="factura.Fecha" />

        <button @onclick="GuardarCabecera">💾 Guardar cambios</button>
        <button @onclick="Volver">🔙 Volver</button>
    </div>

    <h3>Artículos</h3>

    <table border="1" cellpadding="5">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var a in factura.Articulos)
            {
                <tr>
                    <td><input @bind="a.Nombre" /></td>
                    <td><input type="number" min="1" @bind="a.Cantidad" /></td>
                    <td><input type="number" step="0.01" @bind="a.Precio" /></td>
                    <td>@a.Subtotal.ToString("C")</td>
                    <td>
                        <button @onclick="@(() => ActualizarArticulo(a))">Actualizar</button>
                        <button @onclick="@(() => EliminarArticulo(a.Id))">❌ Quitar</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <h4>Agregar Artículo</h4>
    <input placeholder="Nombre" @bind="nuevo.Nombre" />
    <input type="number" min="1" placeholder="Cantidad" @bind="nuevo.Cantidad" />
    <input type="number" step="0.01" placeholder="Precio" @bind="nuevo.Precio" />
    <button @onclick="AgregarArticulo">➕ Agregar</button>

    <h3>Total: @factura.Total.ToString("C")</h3>
}

@code {
    [Parameter] public int id { get; set; }
    private Factura? factura;
    private Articulo nuevo = new();

    protected override async Task OnInitializedAsync()
    {
        factura = await ServicioFacturas.ObtenerFacturaPorId(id);
    }

    private async Task GuardarCabecera()
    {
        if (factura is null) return;

        await ServicioFacturas.ActualizarFacturaCabecera(factura);
        factura = await ServicioFacturas.ObtenerFacturaPorId(id);
        StateHasChanged();
    }

    private async Task ActualizarArticulo(Articulo a)
    {
        await ServicioFacturas.ActualizarArticulo(a);
        factura = await ServicioFacturas.ObtenerFacturaPorId(id);
        StateHasChanged();
    }

    private async Task EliminarArticulo(int articuloId)
    {
        await ServicioFacturas.EliminarArticulo(articuloId);
        factura = await ServicioFacturas.ObtenerFacturaPorId(id);
        StateHasChanged();
    }

    private async Task AgregarArticulo()
    {
        if (factura is null || string.IsNullOrWhiteSpace(nuevo.Nombre)) return;

        await ServicioFacturas.AgregarArticulo(factura.Id, nuevo);
        nuevo = new();
        factura = await ServicioFacturas.ObtenerFacturaPorId(id);
        StateHasChanged();
    }

    private void Volver() => Nav.NavigateTo("/ListaFacturas");
}
